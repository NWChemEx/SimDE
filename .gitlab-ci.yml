
stages:
  - build

before_script:
  - export CMAKE_BUILD_PARALLEL_LEVEL=24
  - export CI_PATH=~/git/gitlabCI/PropertyTypes
  - if [ -d "$CI_PATH" ]; then rm -rf $CI_PATH; fi
  - mkdir -p $CI_PATH/install
  - git clone git@gitlab.com:NWChemEx-Project/CMakeBuild.git $CI_PATH/CMakeBuild
  - git clone git@gitlab.com:NWChemEx-Project/TAMM.git $CI_PATH/TAMM
  - git clone https://github.com/CMakePP/CMakePackagingProject.git $CI_PATH/CMakePP

variables:
  NWX_INSTALL_PATH: "~/git/gitlabCI/Integrals/install"
  CMAKE_OPTIONS: "-DCMAKE_PREFIX_PATH=$NWX_INSTALL_PATH -DCMAKE_INSTALL_PREFIX=$NWX_INSTALL_PATH -DCMAKE_C_COMPILER=gcc -DCMAKE_CXX_COMPILER=g++ -DCMAKE_Fortran_COMPILER=gfortran -DARMCI_NETWORK=MPI-TS -DCPP_GITHUB_TOKEN=a942e188f9c4a0d80d069b826fdb1a3e85f3fe02"
  NUM_CORES: "24"

default_build:
  # only:
  #   - master
  tags:
    - linux,kamban
  stage: build
  script:
    - module load gcc-9.1.0-gcc-7.4.0-jjv2tsg mpich-3.3-gcc-9.1.0-ennj3ix cmake-3.14.2-gcc-9.1.0-jzu7ays
    - cd $CI_PATH/CMakeBuild
    - cmake $CMAKE_OPTIONS -DBUILD_TESTS=OFF -H. -Bbuild
    - cd build
    - make install
    - cd $CI_PATH/TAMM
    - cmake $CMAKE_OPTIONS -DBUILD_TESTS=OFF -H. -Bbuild
    - cd build
    - make -j$NUM_CORES
    - make install
    - cd $CI_PATH/CMakePP
    - cmake $CMAKE_OPTIONS -DBUILD_TESTS=ON -H. -Bbuild
    - cd build
    - make install
    - cd $CI_PROJECT_DIR
    - cmake $CMAKE_OPTIONS -DBUILD_TESTS=ON -H. -Bbuild
    - cd build
    - make -j$NUM_CORES
    - ctest -VV
